<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Assessment - Create Assessment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern-style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Additional styles for the improved interface */
        .question-builder {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 30px var(--shadow-color);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .questions-container {
            margin-bottom: 30px;
        }
        
        .question-item {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            border-left: 4px solid var(--primary-color);
        }
        
        .delete-question {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        .add-option-btn, .add-question-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: #e9ecef;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .add-option-btn:hover, .add-question-btn:hover {
            background-color: #dee2e6;
        }
        
        .add-question-btn {
            background-color: var(--primary-color);
            color: white;
            margin-bottom: 25px;
        }
        
        .add-question-btn:hover {
            background-color: #2d6bce;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-row input {
            flex: 1;
        }
        
        .remove-option {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
        }
        
        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input[type="text"], 
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus, 
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .introduction-card {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: var(--border-radius);
            color: white;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .introduction-card h2 {
            margin-bottom: 15px;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 15px 25px;
            background-color: #f1f3f9;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }

        .question-type-info {
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .file-upload-container {
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .file-upload-container:hover {
            border-color: var(--primary-color);
            background-color: rgba(58, 134, 255, 0.03);
        }
        
        .file-upload-container i {
            font-size: 2rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }
        
        .file-upload-container p {
            margin-bottom: 15px;
        }
        
        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .upload-btn:hover {
            background-color: #2d6bce;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none;
        }
        
        .visual-question-fields {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .instructions-container {
            margin-top: 15px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .create-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px 30px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }
        
        .create-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="backdrop"></div>
        
        <header>
            <div class="logo-container">
                <div class="logo-icon"><i class="fas fa-brain"></i></div>
                <h1>Smart<span>Assessment</span></h1>
            </div>
        </header>
        
        <main class="create-assessment">
            {% if error %}
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>{{ error }}</p>
            </div>
            {% endif %}
            
            <div class="introduction-card">
                <h2><i class="fas fa-file-alt"></i> Create New Assessment</h2>
                <p>Build your assessment by adding questions below. Support for multiple-choice, short answer, explanation, and visual questions with AI-powered assessment.</p>
            </div>
            
            <form method="post" id="assessmentForm" enctype="multipart/form-data">
                <div class="tab-container">
                    <button type="button" class="tab active" id="builderTab">
                        <i class="fas fa-edit"></i> Question Builder
                    </button>
                    <button type="button" class="tab" id="previewTab">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
                
                <div id="builderView">
                    <button type="button" class="add-question-btn" id="addQuestionBtn">
                        <i class="fas fa-plus"></i> Add New Question
                    </button>
                    
                    <div id="questionsContainer" class="questions-container">
                        <!-- Questions will be dynamically added here -->
                    </div>
                    
                    <input type="hidden" id="questions_json" name="questions_json">
                    <input type="hidden" id="answers_json" name="answers_json">
                    
                    <button type="submit" class="create-button" id="createAssessmentBtn">
                        <i class="fas fa-rocket"></i> Create Interactive Assessment
                    </button>
                </div>
                
                <div id="previewView" style="display: none">
                    <div class="question-builder">
                        <h3>Assessment Preview</h3>
                        <div id="previewContainer">
                            <!-- Preview will be generated here -->
                        </div>
                    </div>
                    
                    <button type="button" class="create-button" id="backToEditBtn">
                        <i class="fas fa-edit"></i> Back to Editing
                    </button>
                </div>
            </form>
        </main>
    </div>
    
    <!-- Question template (hidden) -->
    <template id="questionTemplate">
        <div class="question-item" data-question-index="{index}">
            <button type="button" class="delete-question" title="Delete Question">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="question_text_{index}">
                        <i class="fas fa-question-circle"></i> Question Text
                    </label>
                    <textarea id="question_text_{index}" class="question-text" rows="3" required></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="question_type_{index}">
                        <i class="fas fa-list-ul"></i> Question Type
                    </label>
                    <select id="question_type_{index}" class="question-type" required>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="short_answer">Short Answer</option>
                        <option value="explanation">Explanation</option>
                        <option value="visual">Visual Question</option>
                    </select>
                    <div class="question-type-info">
                        Select the type of question you want to create
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="question_points_{index}">
                        <i class="fas fa-star"></i> Points
                    </label>
                    <input type="number" id="question_points_{index}" class="question-points" min="1" value="1" required>
                </div>
            </div>
            
            <!-- Multiple choice options (conditionally shown) -->
            <div class="multiple-choice-fields">
                <label>
                    <i class="fas fa-check-square"></i> Answer Options
                </label>
                <div class="options-container" id="options_container_{index}">
                    <!-- Options will be added here -->
                </div>
                <button type="button" class="add-option-btn" data-index="{index}">
                    <i class="fas fa-plus"></i> Add Option
                </button>
            </div>
            
            <!-- Visual question fields (conditionally shown) -->
            <div class="visual-question-fields hidden">
                <div class="form-group">
                    <label>
                        <i class="fas fa-image"></i> Upload Visual
                    </label>
                    <div class="file-upload-container">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag & drop an image here or click to upload</p>
                        <button type="button" class="upload-btn image-upload-btn" data-index="{index}">
                            <i class="fas fa-upload"></i> Choose File
                        </button>
                        <input type="file" id="image_upload_{index}" class="image-input hidden" accept="image/*">
                        <div class="image-preview" id="image_preview_{index}"></div>
                    </div>
                </div>
                
                <div class="instructions-container">
                    <div class="form-group">
                        <label for="visual_instructions_{index}">
                            <i class="fas fa-info-circle"></i> Instructions for Students
                        </label>
                        <textarea id="visual_instructions_{index}" class="visual-instructions" rows="3" placeholder="Example: Examine the diagram and be prepared to answer questions about the parts labeled A, B, and C."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Short answer fields (conditionally shown) -->
            <div class="short-answer-fields">
                <div class="form-group">
                    <label for="correct_answer_{index}">
                        <i class="fas fa-check-circle"></i> Correct Answer(s)
                    </label>
                    <textarea id="correct_answer_{index}" class="correct-answer" rows="2" placeholder="For multiple acceptable answers, separate with commas"></textarea>
                    <div class="question-type-info">
                        For short answers, you can provide multiple correct options separated by commas
                    </div>
                </div>
            </div>
            
            <!-- Explanation fields (conditionally shown) -->
            <div class="explanation-fields">
                <div class="form-group">
                    <label for="explanation_answer_{index}">
                        <i class="fas fa-check-circle"></i> Model Answer
                    </label>
                    <textarea id="explanation_answer_{index}" class="explanation-answer" rows="4" placeholder="Provide a sample correct answer that covers the key points"></textarea>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Option template (hidden) -->
    <template id="optionTemplate">
        <div class="option-row">
            <input type="text" class="option-text" placeholder="Enter option text">
            <button type="button" class="remove-option">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </template>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let questionCount = 0;
            const questionsContainer = document.getElementById('questionsContainer');
            const questionTemplate = document.getElementById('questionTemplate').content;
            const optionTemplate = document.getElementById('optionTemplate').content;
            const hiddenQuestionsField = document.getElementById('questions_json');
            const hiddenAnswersField = document.getElementById('answers_json');
            
            // Tab navigation
            document.getElementById('builderTab').addEventListener('click', function() {
                document.getElementById('builderView').style.display = 'block';
                document.getElementById('previewView').style.display = 'none';
                document.getElementById('builderTab').classList.add('active');
                document.getElementById('previewTab').classList.remove('active');
            });
            
            document.getElementById('previewTab').addEventListener('click', function() {
                generatePreview();
                document.getElementById('builderView').style.display = 'none';
                document.getElementById('previewView').style.display = 'block';
                document.getElementById('previewTab').classList.add('active');
                document.getElementById('builderTab').classList.remove('active');
            });
            
            document.getElementById('backToEditBtn').addEventListener('click', function() {
                document.getElementById('builderView').style.display = 'block';
                document.getElementById('previewView').style.display = 'none';
                document.getElementById('builderTab').classList.add('active');
                document.getElementById('previewTab').classList.remove('active');
            });
            
            // Add question button
            document.getElementById('addQuestionBtn').addEventListener('click', addNewQuestion);
            
            // Form submission
            document.getElementById('assessmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (questionsContainer.children.length === 0) {
                    alert('Please add at least one question to create an assessment.');
                    return;
                }
                
                // Generate JSON data
                const questionsData = [];
                const answersData = {};
                
                Array.from(questionsContainer.children).forEach((questionItem, index) => {
                    const questionIndex = questionItem.dataset.questionIndex;
                    const questionType = questionItem.querySelector(`.question-type`).value;
                    const questionText = questionItem.querySelector(`.question-text`).value;
                    const points = parseInt(questionItem.querySelector(`.question-points`).value) || 1;
                    
                    // Question data
                    const questionData = {
                        text: questionText,
                        type: questionType
                    };
                    
                    // Answer data
                    const answerData = {
                        points: points
                    };
                    
                    // Add type-specific data
                    if (questionType === 'multiple_choice') {
                        const options = [];
                        questionItem.querySelectorAll('.option-text').forEach(option => {
                            options.push(option.value);
                        });
                        questionData.options = options;
                        
                        // Get correct option - assuming it's the first one for now
                        // In a real implementation, you'd have a way to mark the correct answer
                        answerData.correct_answer = options[0] || '';
                    } 
                    else if (questionType === 'short_answer') {
                        const correctAnswer = questionItem.querySelector('.correct-answer').value;
                        // Split by commas and trim whitespace
                        answerData.correct_answer = correctAnswer.split(',').map(ans => ans.trim());
                    } 
                    else if (questionType === 'explanation') {
                        answerData.correct_answer = questionItem.querySelector('.explanation-answer').value;
                    }
                    else if (questionType === 'visual') {
                        questionData.visual = true;
                        questionData.instructions = questionItem.querySelector('.visual-instructions').value;
                        // In a real implementation, you'd handle file uploads separately
                        // For now, we'll just note that there should be an image
                        questionData.has_image = true;
                        answerData.correct_answer = "This is a visual question evaluated through conversation";
                    }
                    
                    questionsData.push(questionData);
                    answersData[index.toString()] = answerData;
                });
                
                // Set hidden fields
                hiddenQuestionsField.value = JSON.stringify(questionsData);
                hiddenAnswersField.value = JSON.stringify(answersData);
                
                // Submit the form
                this.submit();
            });
            
            // Add a sample question on page load
            addNewQuestion();
            
            // Function to add a new question
            function addNewQuestion() {
                const newQuestion = document.importNode(questionTemplate, true);
                const index = questionCount++;
                
                // Replace all placeholders with the current index
                newQuestion.querySelectorAll('[id$="{index}"]').forEach(el => {
                    el.id = el.id.replace('{index}', index);
                });
                
                newQuestion.querySelectorAll('[data-index="{index}"]').forEach(el => {
                    el.dataset.index = index;
                });
                
                newQuestion.querySelector('.question-item').dataset.questionIndex = index;
                
                // Add two default options for multiple choice
                const optionsContainer = newQuestion.querySelector(`#options_container_${index}`);
                addOption(optionsContainer);
                addOption(optionsContainer);
                
                // Add event listeners
                const questionItem = newQuestion.querySelector('.question-item');
                
                // Delete question button
                questionItem.querySelector('.delete-question').addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this question?')) {
                        questionItem.remove();
                    }
                });
                
                // Add option button
                questionItem.querySelector('.add-option-btn').addEventListener('click', function() {
                    const optionsContainer = document.getElementById(`options_container_${this.dataset.index}`);
                    addOption(optionsContainer);
                });
                
                // Question type change handler
                questionItem.querySelector('.question-type').addEventListener('change', function() {
                    updateQuestionFields(questionItem, this.value);
                });
                
                // Image upload button
                questionItem.querySelector('.image-upload-btn').addEventListener('click', function() {
                    const index = this.dataset.index;
                    document.getElementById(`image_upload_${index}`).click();
                });
                
                // File input change handler
                questionItem.querySelector('.image-input').addEventListener('change', function() {
                    const file = this.files[0];
                    if (!file) return;
                    
                    const index = this.id.split('_').pop();
                    const previewContainer = document.getElementById(`image_preview_${index}`);
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewContainer.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Uploaded Image">`;
                    };
                    reader.readAsDataURL(file);
                });
                
                // Append the new question to the container
                questionsContainer.appendChild(questionItem);
                
                // Initialize with default type (multiple choice)
                updateQuestionFields(questionItem, 'multiple_choice');
            }
            
            // Function to add a new option to a multiple choice question
            function addOption(optionsContainer) {
                const newOption = document.importNode(optionTemplate, true);
                
                // Add event listener to remove button
                newOption.querySelector('.remove-option').addEventListener('click', function() {
                    this.closest('.option-row').remove();
                });
                
                optionsContainer.appendChild(newOption);
            }
            
            // Function to update visible fields based on question type
            function updateQuestionFields(questionItem, type) {
                const multipleChoiceFields = questionItem.querySelector('.multiple-choice-fields');
                const shortAnswerFields = questionItem.querySelector('.short-answer-fields');
                const explanationFields = questionItem.querySelector('.explanation-fields');
                const visualFields = questionItem.querySelector('.visual-question-fields');
                
                // Hide all fields first
                multipleChoiceFields.classList.add('hidden');
                shortAnswerFields.classList.add('hidden');
                explanationFields.classList.add('hidden');
                visualFields.classList.add('hidden');
                
                // Show relevant fields based on type
                switch (type) {
                    case 'multiple_choice':
                        multipleChoiceFields.classList.remove('hidden');
                        break;
                    case 'short_answer':
                        shortAnswerFields.classList.remove('hidden');
                        break;
                    case 'explanation':
                        explanationFields.classList.remove('hidden');
                        break;
                    case 'visual':
                        visualFields.classList.remove('hidden');
                        break;
                }
            }
            
            // Function to generate preview
            function generatePreview() {
                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = '';
                
                if (questionsContainer.children.length === 0) {
                    previewContainer.innerHTML = '<p>No questions added yet. Add questions to see a preview.</p>';
                    return;
                }
                
                // Generate preview for each question
                Array.from(questionsContainer.children).forEach((questionItem, index) => {
                    const questionType = questionItem.querySelector('.question-type').value;
                    const questionText = questionItem.querySelector('.question-text').value;
                    const points = questionItem.querySelector('.question-points').value;
                    
                    const previewCard = document.createElement('div');
                    previewCard.className = 'question-card';
                    
                    let questionContent = `
                        <div class="question-number">Question ${index + 1} - ${points} point${points > 1 ? 's' : ''}</div>
                        <div class="question-content">
                            <div class="question-text">${questionText}</div>
                        </div>
                    `;
                    
                    if (questionType === 'multiple_choice') {
                        const options = Array.from(questionItem.querySelectorAll('.option-text')).map(opt => opt.value);
                        let optionsHTML = `<div class="option-grid">`;
                        
                        options.forEach((option, i) => {
                            optionsHTML += `
                                <div class="option-box">
                                    <div class="option-content">${option}</div>
                                </div>
                            `;
                        });
                        
                        optionsHTML += `</div>`;
                        questionContent += optionsHTML;
                    } 
                    else if (questionType === 'short_answer' || questionType === 'explanation') {
                        questionContent += `
                            <div class="text-answer-container">
                                <textarea placeholder="Enter your answer here..."></textarea>
                                <button class="voice-input-btn">
                                    <i class="fas fa-microphone"></i> Voice Input
                                </button>
                            </div>
                        `;
                    }
                    else if (questionType === 'visual') {
                        const instructions = questionItem.querySelector('.visual-instructions').value || 'Examine the image and answer questions about it.';
                        const imagePreview = questionItem.querySelector('.image-preview').innerHTML;
                        
                        questionContent += `
                            <div class="visual-content">
                                ${imagePreview || '<div class="placeholder-image" style="background-color:#e9ecef;height:200px;display:flex;align-items:center;justify-content:center;border-radius:8px;"><i class="fas fa-image" style="font-size:2rem;color:#adb5bd;"></i></div>'}
                                <div class="visual-instructions" style="margin-top:15px;padding:15px;background-color:#f8f9fa;border-radius:8px;">
                                    <i class="fas fa-info-circle"></i> ${instructions}
                                </div>
                                <div class="text-answer-container" style="margin-top:20px;">
                                    <textarea placeholder="Discuss the visual with the AI here..."></textarea>
                                </div>
                            </div>
                        `;
                    }
                    
                    previewCard.innerHTML = questionContent;
                    previewContainer.appendChild(previewCard);
                });
            }
        });
    </script>
</body>
</html>