<!DOCTYPE html>
<html>
<head>
    <title>Student Assessment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Answer the Questions</h1>
        <p>If you don't understand a question, click the "Help me understand" button.</p>
        
        <form method="post">
            {% for question in questions %}
            {% set question_index = loop.index0 %}
            <div class="question-card">
                <h3>Question {{ loop.index }}</h3>
                
                <!-- Original or rephrased question -->
                <p class="question-text">
                    {% if question.get('rephrased') %}
                    <strong>Simpler version:</strong> {{ question.get('rephrased') }}
                    <br><small>(Original: {{ question.text }})</small>
                    {% else %}
                    {{ question.text }}
                    {% endif %}
                </p>
                
                <!-- Read Aloud Button -->
                <div class="help-buttons">
                    <button type="button" class="read-aloud-btn" data-question-id="{{ question_index }}">
                        <img src="{{ url_for('static', filename='images/speaker.png') }}" alt="Speaker Icon" class="icon">
                        Read Question Aloud
                    </button>
                    
                    <button type="submit" name="help_{{ question_index }}" value="simplify">
                        Help me understand this question
                    </button>
                </div>
                
                <!-- Answer input -->
                <div class="answer-section">
                    {% if question.type == 'multiple_choice' %}
                        <div class="multiple-choice-container">
                            <select id="select_{{ question_index }}" name="answer_{{ question_index }}" class="mc-select">
                                <option value="">Select your answer</option>
                                {% for option in question.options %}
                                <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                            
                            <!-- Read options aloud button -->
                            <button type="button" class="read-options-btn" data-question-id="{{ question_index }}">
                                <img src="{{ url_for('static', filename='images/speaker.png') }}" alt="Speaker Icon" class="icon">
                                Read Options
                            </button>
                        </div>
                    {% else %}
                        <div class="text-answer-container">
                            <textarea 
                                id="answer_{{ question_index }}"
                                name="answer_{{ question_index }}" 
                                rows="4" 
                                placeholder="Write your answer here">{{ current_answers.get('answer_' ~ question_index, '') if current_answers else '' }}</textarea>
                            
                            <!-- Speech-to-text button -->
                            <button type="button" class="speech-to-text-btn" data-question-id="{{ question_index }}">
                                <img src="{{ url_for('static', filename='images/mic.png') }}" alt="Microphone Icon" class="icon">
                                Speak Your Answer
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            <button type="submit" class="submit-button">Submit All Answers</button>
        </form>
    </div>

    <!-- Audio element for text-to-speech playback -->
    <audio id="tts-audio" style="display:none;"></audio>
    
    <!-- Speech recognition status -->
    <div id="speech-status" class="speech-status" style="display:none;">
        <div class="pulse-ring"></div>
        <p>Listening...</p>
        <button id="stop-listening" type="button">Stop</button>
    </div>

    <script>
        // Text-to-Speech Function
        function readTextAloud(text) {
            fetch('/text-to-speech', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.audio_url) {
                    const audio = document.getElementById('tts-audio');
                    audio.src = data.audio_url;
                    audio.play();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to read text aloud. Please try again.');
            });
        }

        // Initialize Speech Recognition
        function initSpeechRecognition(questionId) {
            // Check if browser supports speech recognition
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Your browser does not support speech recognition. Try using Chrome or Edge.');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            // Show speech status
            const speechStatus = document.getElementById('speech-status');
            speechStatus.style.display = 'flex';
            
            let finalTranscript = '';
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Update the textarea or select dropdown based on question type
                const questionType = document.getElementById(`answer_${questionId}`) ? 'text' : 'select';
                
                if (questionType === 'text') {
                    document.getElementById(`answer_${questionId}`).value = finalTranscript;
                } else {
                    // Handle multiple choice by looking for the option word in the spoken text
                    const selectElement = document.getElementById(`select_${questionId}`);
                    const options = Array.from(selectElement.options).map(opt => opt.value.toLowerCase());
                    
                    // Look for option words in the transcript
                    const lowerTranscript = finalTranscript.toLowerCase();
                    for (let i = 0; i < options.length; i++) {
                        if (options[i] && lowerTranscript.includes(options[i].toLowerCase())) {
                            selectElement.value = selectElement.options[i].value;
                            break;
                        }
                    }
                }
            };
            
            recognition.onend = function() {
                speechStatus.style.display = 'none';
            };
            
            // Start recognition
            recognition.start();
            
            // Stop button functionality
            document.getElementById('stop-listening').onclick = function() {
                recognition.stop();
                speechStatus.style.display = 'none';
                
                // Send the final transcript to the server for processing
                fetch('/process-speech', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question_id: questionId,
                        speech_text: finalTranscript 
                    }),
                });
            };
            
            return recognition;
        }

        // Add event listeners after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Read Question Aloud buttons
            const readAloudButtons = document.querySelectorAll('.read-aloud-btn');
            readAloudButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-question-id');
                    const questionElements = document.querySelectorAll('.question-text');
                    const questionText = questionElements[questionId].textContent.trim();
                    readTextAloud(questionText);
                });
            });
            
            // Read Options Aloud buttons (for multiple choice)
            const readOptionsButtons = document.querySelectorAll('.read-options-btn');
            readOptionsButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-question-id');
                    const selectElement = document.getElementById(`select_${questionId}`);
                    
                    if (selectElement) {
                        const options = Array.from(selectElement.options)
                            .map(option => option.text)
                            .filter(text => text !== 'Select your answer')
                            .join('. ');
                        
                        readTextAloud(`Your options are: ${options}`);
                    }
                });
            });
            
            // Speech to Text buttons
            const speechToTextButtons = document.querySelectorAll('.speech-to-text-btn');
            let currentRecognition = null;
            
            speechToTextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-question-id');
                    
                    // Stop any existing recognition
                    if (currentRecognition) {
                        currentRecognition.stop();
                    }
                    
                    // Start new recognition
                    currentRecognition = initSpeechRecognition(questionId);
                });
            });
        });
    </script>
</body>
</html>